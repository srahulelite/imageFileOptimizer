<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>File Optimizer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --primary:#2563eb;
  --danger:#dc2626;
  --muted:#6b7280;
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
}

* { box-sizing:border-box; }
body {
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:var(--bg);
}

.container {
  max-width:1000px;
  margin:40px auto;
  padding:0 20px;
}

.tabs { display:flex; gap:6px; margin-bottom:20px; }
.tab {
  padding:10px 18px;
  border-radius:8px;
  cursor:pointer;
  background:#e5e7eb;
  font-weight:600;
}
.tab.active { background:var(--primary); color:#fff; }

.card {
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
}

.controls {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

.hint p{ margin:6px 0 0 0; color:var(--muted); font-size:14px; }

.table { width:100%; border-collapse:collapse; margin-top:12px; }
.table th,.table td { padding:10px; border-bottom:1px solid var(--border); text-align: left; }

.error { color:var(--danger); margin:10px 0px;}
button { padding:10px 16px; border-radius:8px; border:none; background:var(--primary); color:white; cursor:pointer; }
button:disabled { opacity:.5; cursor:not-allowed; }
select { padding:6px 10px; border-radius:6px; }

</style>
</head>

<body>
<div class="container">

<h1>File Optimizer</h1>

<div class="tabs">
  <div class="tab active" data-tab="image">Images</div>
  <div class="tab" data-tab="video">Videos</div>
</div>

<!-- IMAGE TAB -->
<div class="card" id="imageTab">
  <div class="controls">
    <strong>Optimize Images</strong>
  </div>
  <div class="controls" style="margin-top:12px;">
  <select id="imageQuality">
    <option value="low">Low quality (smaller size)</option>
    <option value="avg" selected>Average quality</option>
    <option value="high">High quality (larger size)</option>
  </select>
</div>

  <input type="file" id="imageInput" multiple accept="image/*" />
  <div class="hint">
  <p>*Image limits:
  • Max 5 images
  • Max 30 MB per image
  • Max 150 MB total</p>
</div>

  <table class="table">
    <thead><tr><th>File</th><th>Size</th><th>Delete</th></tr></thead>
    <tbody id="imageTable"></tbody>
  </table>

  <div id="imageError" class="error"></div>
  <button id="imageSubmit" disabled>Optimize Images</button>
</div>

<!-- VIDEO TAB -->
<div class="card" id="videoTab" style="display:none">
  <div class="controls">
    <strong>Optimize Videos</strong>
  </div>
  <div class="controls" style="margin-top:12px;">
  <select id="videoQuality">
    <option value="low">Low quality (smaller size)</option>
    <option value="avg" selected>Average quality</option>
    <option value="high">High quality (larger size)</option>
  </select>
</div>

  <input type="file" id="videoInput" multiple accept="video/*" />
  <div class="hint">
  <p>*Video limits:
  • Max 2 videos
  • Max 150 MB per video
  • Max 300 MB total </p>
</div>

  <table class="table">
    <thead><tr><th>File</th><th>Size</th><th>Delete</th></tr></thead>
    <tbody id="videoTable"></tbody>
  </table>

  <div id="videoError" class="error"></div>
  <button id="videoSubmit" disabled>Optimize Videos</button>
</div>

</div>

<script>
/* ---------------- TAB SWITCH ---------------- */
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    imageTab.style.display = tab.dataset.tab === 'image' ? 'block' : 'none';
    videoTab.style.display = tab.dataset.tab === 'video' ? 'block' : 'none';
  };
});

/* ---------------- UTIL ---------------- */
const human = b => b<1024?`${b} B`:b<1e6?`${(b/1024).toFixed(1)} KB`:`${(b/1e6).toFixed(1)} MB`;

/* ================= IMAGE STATE ================= */
let imageState = [];
const imageInput = document.getElementById('imageInput');
const imageTable = document.getElementById('imageTable');
const imageSubmit = document.getElementById('imageSubmit');
const imageError = document.getElementById('imageError');

imageInput.onchange = () => {
  if (!imageInput.files.length) return;
  [...imageInput.files].forEach(f => imageState.push(f));
  imageInput.value = '';
  renderImages();
};

function renderImages() {
  imageTable.innerHTML = '';
  imageSubmit.disabled = true;
  imageError.textContent = '';

  if (!imageState.length) return;

  let total = 0, err=false;
  imageState.forEach((f,i) => {
    total += f.size;
    if (f.size > 30 * 1024 * 1024) err=true;
    imageTable.innerHTML += `
      <tr>
        <td>${f.name}</td>
        <td>${human(f.size)}</td>
        <td><button onclick="imageRemove(${i})">✕</button></td>
      </tr>`;
  });

  if (
    imageState.length > 5 ||
    total > 150 * 1024 * 1024 ||
    imageState.some(f => f.size > 30 * 1024 * 1024)
  ) {
    imageError.textContent = 'Image limits exceeded.';
    return;
  }
  imageSubmit.disabled = false;
}

function imageRemove(i){ imageState.splice(i,1); renderImages(); }

/* ================= VIDEO STATE ================= */
let videoState = [];
const videoInput = document.getElementById('videoInput');
const videoTable = document.getElementById('videoTable');
const videoSubmit = document.getElementById('videoSubmit');
const videoError = document.getElementById('videoError');

videoInput.onchange = () => {
  if (!videoInput.files.length) return;
  [...videoInput.files].forEach(f => videoState.push(f));
  videoInput.value = '';
  renderVideos();
};

function renderVideos() {
  videoTable.innerHTML = '';
  videoSubmit.disabled = true;
  videoError.textContent = '';

  if (!videoState.length) return;

  let total = 0, err=false;
  videoState.forEach((f,i) => {
    total += f.size;
    if (f.size > 150*1024*1024) err=true;
    videoTable.innerHTML += `
      <tr>
        <td>${f.name}</td>
        <td>${human(f.size)}</td>
        <td><button onclick="videoRemove(${i})">✕</button></td>
      </tr>`;
  });

  if (videoState.length>2 || total>300*1024*1024 || err) {
    videoError.textContent = 'Video limits exceeded.';
    return;
  }
  videoSubmit.disabled = false;
}

function videoRemove(i){ videoState.splice(i,1); renderVideos(); }

/* ================= IMAGE UPLOAD ================= */
imageSubmit.onclick = async () => {
  showProgress('Optimizing images…');

  const fd = new FormData();
  imageState.forEach(f => fd.append('files[]', f));
  fd.append('quality', document.getElementById('imageQuality').value);

  try {
    const res = await fetch('/api/upload', { method:'POST', body:fd });
    if (!res.ok) throw new Error('Image optimization failed');

    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'optimized_images.zip';
    a.click();

    imageState = [];
    renderImages();
  } catch (e) {
    imageError.textContent = e.message;
  } finally {
    hideProgress();
  }
};



videoSubmit.onclick = async () => {
  showProgress('Optimizing videos (this may take time)…');

  const fd = new FormData();
  videoState.forEach(f => fd.append('files[]', f));
  fd.append('quality', document.getElementById('videoQuality').value);

  try {
    const res = await fetch('/api/video/optimize', {
      method:'POST',
      body:fd
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || 'Video optimization failed');
    }

    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'optimized_videos.zip';
    a.click();

    videoState = [];
    renderVideos();
  } catch (e) {
    videoError.textContent = e.message;
  } finally {
    hideProgress();
  }
};


function showProgress(text) {
  document.getElementById('progressText').textContent = text || 'Processing…';
  document.getElementById('progressModal').style.display = 'flex';
}

function hideProgress() {
  document.getElementById('progressModal').style.display = 'none';
}


</script>

<!-- Progress Modal -->
<div id="progressModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    padding:24px 32px;
    border-radius:12px;
    min-width:300px;
    text-align:center;
  ">
    <div style="
      width:36px;
      height:36px;
      border:4px solid #e5e7eb;
      border-top:4px solid #2563eb;
      border-radius:50%;
      margin:0 auto 16px;
      animation:spin 1s linear infinite;
    "></div>
    <div id="progressText" style="font-weight:600;">
      Processing…
    </div>
  </div>
</div>

<style>
@keyframes spin {
  to { transform:rotate(360deg); }
}
</style>

</body>
</html>
